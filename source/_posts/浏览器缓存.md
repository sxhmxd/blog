---
title: 浏览器缓存
---

浏览器对于请求资源，拥有一些成熟的缓存策略，按照发生的时间顺序分别为 `存储策略、过期策略、协商策略`。其中 `存储策略` 在收到响应后应用，`过期策略、协商策略` 在发送请求前应用

![浏览器缓存机制剖析图](https://lc-gold-cdn.xitu.io/54a021d766b64e993d39.png)

### http header 中与缓存有关的 key

| key           | 描述                             | 策略类型 |
| ------------- | -------------------------------- | -------- |
| Cache-Control | 指定缓存机制，覆盖其它设置       | 存储策略 |
| Pragma        | http1.0 字段，指定缓存机制       | 存储策略 |
| Expires       | http1.0 字段，指定缓存的过期时间 | 过期策略 |
| Last-Modified | 资源最后一次的修改时间           | 协商策略 |
| ETag          | 唯一标识请求资源的字符串         | 协商策略 |

### 缓存协商策略用于重新验证缓存资源是否有效

| key                | 描述                                                                    |
| ------------------ | ----------------------------------------------------------------------- |
| if-Modified-Since  | 缓存校验字段，值为资源最后一次修改的时间，即上次收到的 Last-Modified 值 |
| if-Unmodifed-Since | 与上面相同，处理方式与上面相反                                          |
| if-Match           | 缓存校验字段，值为唯一标识请求资源的字符串，即上次的 ETag 值。          |
| if-None-Match      | 同上，处理方式与之相反                                                  |

### Cache-Control

浏览器缓存里，`Cache-Control` 是金字塔顶尖的规则，它藐视一切其他设置，只要其他设置与其抵触，一律覆盖，它还是一个复合规则，包含多种值，横跨 `存储策略、过期策略` 两种,同时在请求头和响应头都可设置。
语法 `Cache-Control:cache-directive`

| Cache-directive | 描述                                                                                                | 存储策略 | 过期策略 | 请求字段 | 响应字段 |
| --------------- | --------------------------------------------------------------------------------------------------- | -------- | -------- | -------- | -------- |
| public          | 资源将被客户端和代理服务器缓存                                                                      | 是       | 否       | 否       | 是       |
| private         | 资源仅被客户端缓存，代理服务器不缓存                                                                | 是       | 否       | 否       | 是       |
| no-store        | 请求和响应都不缓存                                                                                  | 是       | 否       | 是       | 是       |
| no-cache        | 相当于 max-age:0,must-revalidate 即资源被缓存，但是缓存立刻过期，同时下次访问时强制验证资源有效性。 | 是       | 是       | 是       | 是       |
| max-age         | 缓存资源，但是指定时间(单位为秒)后缓存过期                                                          | 是       | 是       | 是       | 是       |

### Pragma

http1.0 字段，通常设置为 Pragma:no-cache,作用同 Cache-Control:no-cache,当一个 no-cache 请求发送给一个不遵循 HTTP/1.1 的服务器时，客户端应该包含 pragma 指令。

### Expires

即将到期时间，以服务器时间为参考系，其优先级比 Cache-Control:max-age 低，两者同时出现在响应头时， Expires 将被后者覆盖，如果 Expires, Cache-Control:max-age 或 Cache-Control:s-maxage 都没有在响应头中出现，并且也没有其它缓存的设置，那么浏览器默认会采用一个启发式算法，通常会取响应头的 Date_value -Last-Modified_value 值的 10%作为缓存时间。

### ETag

实体标签，服务器资源的唯一标识符，浏览器可以根据 ETag 值缓存数据，节省宽带，如果资源已经改变，etag 可以帮助防止同步更新资源的相互覆盖，ETag 优先级比 Last-Modified 高。

### If-Match

语法：if-Match:ETag_value 或者 if-match:ETag_value,ETag_value
缓存校验字段，其值为上次收到的一个或多个 etag 值，常用于判断条件是否满足

### Last-Modified

用于标记请求资源的最后一次修改时间，格式为 GMT(格林尼治标准时间)。优先级比 ETag 低，且只能精确到秒，因此不适合短时间内频繁的改动的资源，服务器端的静态资源，通常需要编译打包，可能出现资源内容没有改变，而 Last-Modified 却改变的情况。

### If-Modified-Since

缓存校验字段，其值为上次响应头的 Last-Modified 值，若与请求资源当前的 Last-Modified 值相同，那么将返回 304 状态码的响应，反之将返回 200 状态码响应。

### If-Unmodified-Since

缓存校验字段，表示资源未修改则正常执行更新，否则返回 412 状态码的响应。

### 强缓存

一旦资源命中强缓存，浏览器便不会向服务器发送请求，而是直接读取缓存。对于常规请求，只要存在该资源的缓存，且 Cache-Control:max-age 或者 expires 没有过期，那么就命中强缓存。

### 协商缓存

协商缓存的响应结果，不仅验证了资源的有效性，同时还更新了浏览器缓存。
缓存过期后，继续请求该资源。有两种做法。

- 根据上次响应中的 ETag_value,自动往 request header 中添加 If-None-Match 字段的值与资源的 ETag 值进行比较，若相同，则命中协商缓存，返回 304 响应。
- 根据上次响应中的 Last-Modified_vlaue,自动往 request header 中添加 If-Modified-Since 字段，服务器收到请求后，拿 If-Modified-Since 字段的值与资源的 Last-Modified 值进行比较，若相同，则命中协商缓存，返回 304 响应。
