---
title: CommonJS AMD CMD ES6
categories: [JS 模块化, CommonJS&AMD&CMD&ES6]
---
## CommonJS 规范
  ### 模块的定义
    1、 `每个文件就是一个模块`，有自己的作用域。在一个文件里面定义的变量、函数、类、都是私有的，对其他文件不可见。
    2、在模块中使用global定义全局变量，不需要导出，在别的文件中可以访问到。
    3、在每个模块内部，module 变量代表当前模块。这个变量是一个对象，它的exports 属性(module.exports) 是`对外的接口`。
    4、通过require 加载模块，读取并执行一个 js 文件，然后 `返回该模块的exports对象`
    5、所有代码都运行在模块作用域，不会污染全局作用域。
    6、模块可以加载多次，但是`只会在第一次加载时运行一次，然后运行结果就被缓存了`，以后再加载马，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。
    7、模块的加载顺序，按照其`在代码中出现的顺序`
  ### module 对象
    node 内部提供了一个module 构建函数。所有的模块其实都是Module 的实例。
    每一个模块内部，都有一个Module 对象，代表当前模块。具有的属性：
      - module.id 模块的识别符，通常是带有绝对路径的模块文件名。
      - module.filename 模块的文件名，带有绝对路径；
      - module.loaded 返回一个boolean 值，表示模块是否已经完成加载
      - module.parent 返回一个对象，表示调用该模块的模块
      - module.children 返回一个数组，表示该模块内用到的其他模块
      - module.exports 表示模块对外输出的值。

  #### module.exports 属性和export 变量
    module.exports 属性表示当前模块对外输出的接口，其他文件加载该模块就是读取module.export 变量。为了方便，node为每一个模块体提供了一个export变量，指向 module.export。者等同在每一个文件头部，有一条这样的命令。 
    ```
      var exports = module.exports
    ```
    所以我们在对外输出模块接口时，可以向 exports对象中添加方法或者属性
    ```
      module.export.name  = 'module'
      exports.name = '测试'
      exports.age = 18
      //  下面的操作是错误的
      exports = 'xx'
      exports = function () {}
       
    ```
    `不可以直接将exports变量指向一个值`，这样等同于切断了 expors 和 module.exports 的联系。这意味着，如果一个模块的对外接口，是一个单一的值，这种情况就不能直接使用exports 输出，只能使用module.exports 输出。
  ## require 
    `require命令` 用于`加载模块文件` 它的基本功能是，读取并执行一个Javascript文件，然后返回该模块的exports 对象。
  CommonJS 模块的加载机制是，输入的是被输出的值的拷贝。也就是说，一旦输出一个值，模块内部的变化就影响不到这个值。
  ### require 的内部处理流程
    - 先检查 Module._cache,看里面有没有对应模块的缓存；
    - 如果有缓存没有的化就创建一个新的moudule 实例，并把它添加到缓存中，缓存的是它 exports导出的值；
    - 如果缓存中有的话，使用module.load() 这个方法，去加载这个模块，读取文件内容后，使用module.compile()执行文件代码。
    - 如果解析的过程中，出现异常，就从缓存中删除这个模块；
    - 如果没有出现异常，最后返回这个模块的module.exports;
  ### 加载规则
    根据参数的不同格式，require 命令去不同路径寻找模块文件。
    * 如果参数字符串以 "/" 开头 ，表示加载的是一个位于`绝对路径` 的模块文件。
    * 如果参数字符串以 "./" 开头，表示加载的是位于`相对路径`(跟当前执行脚本的位置相比)的模块文件。
    * 如果参数字符串不以`"/"` 或者`"./"` 开头，则表示加载的是一个默认提供的`核心模块`(位于Node的系统安装目录中)，或者一个位于各级 node_module目录的`已安装模块`(全局安装或者局部安装)。
    * 如果参数字符串不以 "/" 或者 "./" 开头，而是一个路径，则会先找到该路径目录，然后再以它为参数找到后续路径。
    * 如果指定的模块文件没有被发现，Node 会尝试为文件添加.js、.json、.node后，再去搜索。.js 文件会以文本格式的javascript脚本文件解析，.json文件会以JSON格式的文本文件解析，.node文件会以编译后的二进制文件解析。
    * 如果想得到require 命令加载的确切文件名，使用require.resolve() 方法。   
