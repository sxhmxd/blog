---
title: [Vue.js 源码解读, 数据的变化侦听]
categories: [Vue.js 源码解读, 变化侦测, 数据的变化侦听]
tags: 
  - Vue.js 源码解读
---

# 数据变化侦测

vue 是 MVVM 的实现是数据驱动视图，数据可以理解成状态，视图就是用户看到的界面。显示的界面不可能是不发生变化的，变化可能是用户操作引起的，或者是后台数据的变化引起的，将引起变化的统称为状态的变化。
UI = render(state)

`state`是输入，UI 是输出，当 state 发生变化，UI 也发生变化。称之为数据驱动视图。
ui 和 state 是用户定义的，render 是不变的，vue 充当的就是 render(),vue 发现 state 发生变化，经过一系列的加工最终反映在界面上。

## 什么是变化侦测

变化侦测就是追踪状态，也就是数据发生变化，就去更新视图。
变化侦测在三大框架中均有涉及，angular 是靠脏值检查流程实现变化侦听。react 是通过对比虚拟 DOM 来实现变化侦测。

### Object 实现变化侦测

#### 使 object 数据变的可观测

数据的每次读和写都能被我们看的见，即我们知道数据什么时候被读取了，数据什么时候被改写了。

```
let car = {}
let value =1000
Object.defineProperty(car,'price',{
  enumerable:true,    // 对象是否可以通过 for-in 循环，false  不可以
  configurable:true,  // 能否使用delete、能否修改属性的特性。false为不可以重新定义。
  get(){
    return value
  },
  set(newVal){
    val = newVal
  }
})
```

通过 Object.defineProperty(),方法给 car 定义了一个 prices 属性，并把这个属性的读和写分别使用
get()和 set()进行拦截，每当进行读和写的时候都会触发 get 和 set 方法。
可以看到 car 已经主动告诉我们他的属性读写情况，也就是这个 car 的数据已经是`可观测`的了
上面的实例只实现了 car 一个属性的可观测，将方法进行封装实现所有的属性可观测

```
export class Observe {
  constructor(value){
    this.value = value
    def(value,'__ob__',this)
  }
  if(Array.isArray(value)){

  } else {
    this.walk(value)
  }
}
walk(obj:Object){
  const keys = Object.keys(obj)
  for(let i=0;i<keys.length;i++){
    defineReactive(obj,keys[i])
  }
}
functon defineReactive (obj,key,val){
  if(argument.length ===2){
    val = obj[key]
  }
  if(typeof val === 'object'){
     new Observe(val)
  }
  Object.defineProperty(obj,key,{
    enumerable:true,
    configurable:true,
    get(){
      return val
    },
    set(newVal){
      val = newVal
    }
  })
}
```

## 依赖收集

### 什么是依赖收集

通过 Observer 可以检测到数据的变化，数据变化通知视图更新，但是视图非常的大，不能一个数据发生变化视图就更新。那么想到不能全部更新视图只需要更新用到这个数据的地方更新，
